<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="google-site-verification"
      content="w75-P-0ywXWkyZvYPbkSM3VSM2hny25UrfeiWJt3B1k"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta
      name="description"
      content="Front-end developer and designer. ReasonML, ReasonReact, ReactJS."
    />
    <meta name="twitter:card" content="summary_large_image">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://bloodyowl.io/public/assets/images/share.jpg">
    <meta name="twitter:image" content="https://bloodyowl.io/public/assets/images/share.jpg">
    <meta name="twitter:site" content="@bloodyowl">
    <meta property="og:image:width" content="1500">
    <meta property="og:image:height" content="777">
    <link rel="shortcut icon" href="/public/assets/images/favicon.png" />
    <title>Orchestrating requests at component level | @bloodyowl</title><meta property="og:title" content="Orchestrating requests at component level | @bloodyowl" />
  </head>
  <body>
    <div id="root"><style data-emotion-css="189z874 gu50q 1sk4geg 12as1jd inii90 kk4a7b 16cj527 1moa3kc 18av5pk 1jtjujg j1f6xt a7hgs6 1h80fpx saz23d 2o7l8j bgur92 gghbgz 18z74vx 1qdfdal">pre{padding:10px 20px;background-color:#F4F7F8;overflow-x:auto;-webkit-overflow-scrolling:touch;font-size:14px;}code{font-family:PragmataPro,SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;line-height:1;}.hljs-keyword{color:#DA6BB5;}.hljs-constructor{color:#DD792B;}.hljs-identifier{color:#1E9EA7;}.hljs-module-identifier{color:#C84682;}.hljs-string{color:#3BA1C8;}.hljs-comment{color:#aaa;}.hljs-operator{color:#DA6BB5;}.hljs-attribute{color:#4CB877;}table{width:100%;text-align:center;}table thead th{background-color:#E4EBEE;padding:10px 0;}blockquote{opacity:0.6;border-left:4px solid #46515B;margin:0;padding:0 20px;}@font-face{font-family:Madera;src:url("/public/assets/webfonts/madera.ttf");font-style:normal;font-weight:400;font-display:swap;}@font-face{font-family:Madera;src:url("/public/assets/webfonts/madera-bold.ttf");font-style:normal;font-weight:700;font-display:swap;}body{padding:0;margin:0;background-color:#fff;font-family:Madera,"Helvetica Neue",Helvetica,Arial,sans-serif;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100vh;overflow-x:hidden;}#root{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}html{color:#46515B;font-size:1em;line-height:1.4;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%;}*,*:before,*:after{box-sizing:border-box;}</style><style data-emotion-css="1lm8k0f">.css-1lm8k0f{min-height:100vh;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;}</style><div class="css-1lm8k0f" data-reactroot=""><style data-emotion-css="14wlb7f">.css-14wlb7f{background-color:#E4EBEE;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}@media (max-width:620px){.css-14wlb7f{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="css-14wlb7f"><style data-emotion-css="48zunz">.css-48zunz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;color:#46515B;-webkit-text-decoration:none;text-decoration:none;}</style><a href="/" class="css-48zunz"><style data-emotion-css="19jaiin">.css-19jaiin{margin-right:10px;margin-left:20px;-webkit-align-self:center;-ms-flex-item-align:center;align-self:center;}</style><img class="css-19jaiin" alt="" height="32" src="/public/assets/images/owl.svg" width="32"/><style data-emotion-css="16ucz1n">.css-16ucz1n{padding:20px 20px 23px 0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div aria-level="1" class="css-16ucz1n" role="heading"><style data-emotion-css="x6blf3">.css-x6blf3{font-weight:700;margin-right:10px;white-space:nowrap;}</style><div class="css-x6blf3">Matthias Le Brun</div><div>@bloodyowl</div></div></a><style data-emotion-css="7nltf6">.css-7nltf6{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}@media (max-width:620px){.css-7nltf6{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;background-color:#D4E1E6;}}</style><div class="css-7nltf6"><style data-emotion-css="143gsgu">.css-143gsgu{padding:20px 20px 23px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-text-decoration:none;text-decoration:none;color:#46515B;text-align:center;font-weight:700;}@media (max-width:620px){.css-143gsgu{-webkit-flex-basis:33.333%;-ms-flex-preferred-size:33.333%;flex-basis:33.333%;padding:10px 20px 13px;}}</style><a href="/blog/" class="css-143gsgu">Blog</a><style data-emotion-css="1o16z30">.css-1o16z30{padding:20px 20px 23px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-text-decoration:none;text-decoration:none;color:#46515B;text-align:center;}@media (max-width:620px){.css-1o16z30{-webkit-flex-basis:33.333%;-ms-flex-preferred-size:33.333%;flex-basis:33.333%;padding:10px 20px 13px;}}</style><a href="https://twitter.com/bloodyowl" class="css-1o16z30">Twitter</a><a href="https://github.com/bloodyowl" class="css-1o16z30">GitHub</a></div></div><style data-emotion-css="12z655i">.css-12z655i{max-width:600px;padding:0 10px;margin:20px auto;width:100%;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div class="css-12z655i"><style data-emotion-css="1lz15hj">.css-1lz15hj{margin:0;margin-bottom:10px;}</style><h1 class="css-1lz15hj">Orchestrating requests at component level</h1><style data-emotion-css="v7jbmu">.css-v7jbmu{font-size:14px;opacity:0.5;}</style><div class="css-v7jbmu">2019/01/24</div><style data-emotion-css="b2zag1">.css-b2zag1{margin-top:40px;font-size:18px;}.css-b2zag1 a{color:#135EFF;}.css-b2zag1 a:hover{color:#13A3FF;}</style><div class="css-b2zag1"><p><a href="/blog/2019-01-20-requests-with-reasonml/">In a previous article</a>, we saw how we can model request statuses in our ReasonReact component state, so that we prevent weird or impossible states.</p>
<p>Now, let's see how we can orchestrate them <strong>within</strong> our components.</p>
<p>When I was using JavaScript, I generally put all the logic involving server requests in Redux. This wasn't an obligation, but thinking in actions really helped figuring out what was happening, which was harder when calling <code>setState</code> all over the place. Using Reason, and given the evolution of React, I feel I don't need this anymore:</p>
<ul>
<li>with reducer components, <strong>thinking in actions and state</strong> can happen locally</li>
<li>props drilling is ok when backed by a <strong>static type system</strong></li>
<li>portals reduce the need for a global store that components subscribe to: you can <strong>pass the data</strong> from a component <strong>to a portal</strong> that's rendered elsewhere</li>
<li>true isolation between components makes a lot of things easier: they're <strong>reusable</strong>, their <strong>data dependencies are explicit</strong> and statically analysable, and their implementation doesn't leak to a shared store</li>
<li>reducer components embed a <a href="https://reasonml.github.io/reason-react/docs/en/state-actions-reducer#state-update-through-reducer">powerful update mechanism</a>, which is much more practical than using lifecycle or chaining promises in actions</li>
</ul>
<h2>In practice</h2>
<p>Let's say we have a component that needs to fetch a <code>User</code> and then fetch their <code>Statistics</code>, which are identified by a value we might find in the payload of the first request.</p>
<p>First, we can write an interface file (<code>.rei</code>) that lets us define what we want to expose from the implementation file we're about to do:</p>
<pre><code class="language-reason"><span class="hljs-keyword">type</span> state;

<span class="hljs-keyword">type</span> action;

<span class="hljs-keyword">let</span> make = array(<span class="hljs-module-identifier">React</span>.reactElement) =&gt;
  <span class="hljs-module-identifier">React</span>.component(state, <span class="hljs-module-identifier">React</span>.noRetainedProps, action);
</code></pre>
<p>This will help the compiler notice dead code, and making <code>state</code> and <code>action</code> opaque to the outside world even enables us to check if action constructors ever used, enabling the removal of entire codepaths that aren't ever executed!</p>
<p>Now for the implementation file:</p>
<p>Define the state we want:</p>
<pre><code class="language-reason"><span class="hljs-keyword">type</span> state = {
  user: <span class="hljs-module-identifier">RequestStatus</span>.t(<span class="hljs-module-identifier">Result</span>.t(<span class="hljs-module-identifier">User</span>.t, <span class="hljs-module-identifier">Errors</span>.t)),
  statistics: <span class="hljs-module-identifier">RequestStatus</span>.t(<span class="hljs-module-identifier">Result</span>.t(<span class="hljs-module-identifier">Statistics</span>.t, <span class="hljs-module-identifier">Errors</span>.t)),
};
</code></pre>
<p>The actions that will occur:</p>
<pre><code class="language-reason"><span class="hljs-keyword">type</span> action =
  | <span class="hljs-constructor">LoadUser</span>
  | <span class="hljs-constructor">ReceiveUser</span>(<span class="hljs-module-identifier">Result</span>.t(<span class="hljs-module-identifier">User</span>.t, <span class="hljs-module-identifier">Errors</span>.t))
  | <span class="hljs-constructor">LoadStatistics</span>(string)
  | <span class="hljs-constructor">ReceiveStatistics</span>(<span class="hljs-module-identifier">Result</span>.t(<span class="hljs-module-identifier">Statistics</span>.t, <span class="hljs-module-identifier">Errors</span>.t));
</code></pre>
<p>Our initial state will look like this:</p>
<pre><code class="language-reason"><span class="hljs-keyword">let</span> initialState = {user: <span class="hljs-constructor">NotAsked</span>, statistics: <span class="hljs-constructor">NotAsked</span>};
</code></pre>
<p>So, we now have the basics! We can start writing our reducer:</p>
<pre><code class="language-reason"><span class="hljs-keyword">let</span> reducer = (action, state) =&gt;
  <span class="hljs-keyword">switch</span> (action) {
  <span class="hljs-comment">/* show as loading, then start the request */</span>
  | <span class="hljs-constructor">LoadUser</span> =&gt;
    <span class="hljs-constructor">UpdateWithSideEffects</span>(
      {<span class="hljs-operator">...</span>state, user: <span class="hljs-constructor">Loading</span>},
      (
        ({send}) =&gt;
          <span class="hljs-module-identifier">User</span>.get()<span class="hljs-operator">-&gt;</span><span class="hljs-module-identifier">Future</span>.get(payload =&gt; send(<span class="hljs-constructor">ReceiveUser</span>(payload)))
      ),
    )
  <span class="hljs-comment">/* when we find a statisticsKey, set the user and start the second request */</span>
  | <span class="hljs-constructor">ReceiveUser</span>(<span class="hljs-constructor">Ok</span>({statisticsKey: <span class="hljs-constructor">Some</span>(key)}) <span class="hljs-keyword">as</span> user) =&gt;
    <span class="hljs-constructor">UpdateWithSideEffects</span>(
      {<span class="hljs-operator">...</span>state, user: <span class="hljs-constructor">Done</span>(user)},
      (({send}) =&gt; send(<span class="hljs-constructor">LoadStatistics</span>(key))),
    )
  <span class="hljs-comment">/* otherwise just set the user */</span>
  | <span class="hljs-constructor">ReceiveUser</span>(user) =&gt; <span class="hljs-constructor">Update</span>({<span class="hljs-operator">...</span>state, user: <span class="hljs-constructor">Done</span>(user)})
  | <span class="hljs-constructor">LoadStatistics</span>(key) =&gt;
    <span class="hljs-constructor">UpdateWithSideEffects</span>(
      {<span class="hljs-operator">...</span>state, statistics: <span class="hljs-constructor">Loading</span>},
      (
        ({send}) =&gt;
          <span class="hljs-module-identifier">Statistics</span>.get(key)
          <span class="hljs-operator">-&gt;</span><span class="hljs-module-identifier">Future</span>.get(payload =&gt; send(<span class="hljs-constructor">ReceiveStatistics</span>(payload)))
      ),
    )
  | <span class="hljs-constructor">ReceiveStatistics</span>(statistics) =&gt;
    <span class="hljs-constructor">Update</span>({<span class="hljs-operator">...</span>state, statistics: <span class="hljs-constructor">Done</span>(statistics)})
  };
</code></pre>
<p>Pattern matching our actions is really interesting here:</p>
<ul>
<li>If the <code>User</code> request fails or doesn't contain a <code>statisticsKey</code>, we don't even bother querying <code>Statistics</code>: we just store the error or user in state, and can render UI accordingly</li>
<li>We can easily see the request chaining</li>
</ul>
<p>All that's left to do is a bit of pattern matching in our render function:</p>
<pre><code class="language-reason"><span class="hljs-keyword">switch</span> (state.user) {
| <span class="hljs-constructor">NotAsked</span> =&gt; <span class="hljs-module-identifier">React</span>.null
| <span class="hljs-constructor">Loading</span> =&gt; &lt;<span class="hljs-module-identifier">ActivityIndicator</span> /&gt;
| <span class="hljs-constructor">Done</span>(<span class="hljs-constructor">Error</span>(error)) =&gt; &lt;<span class="hljs-module-identifier">ErrorIndicator</span> error /&gt;
| <span class="hljs-constructor">Done</span>(<span class="hljs-constructor">Ok</span>(user)) =&gt;
  &lt;&gt;
    &lt;<span class="hljs-module-identifier">UserCard</span> user /&gt;
    {
      <span class="hljs-keyword">switch</span> (state.statistics) {
      | <span class="hljs-constructor">NotAsked</span> =&gt; <span class="hljs-module-identifier">React</span>.null
      | <span class="hljs-constructor">Loading</span> =&gt; &lt;<span class="hljs-module-identifier">ActivityIndicator</span> /&gt;
      | <span class="hljs-constructor">Done</span>(<span class="hljs-constructor">Error</span>(error)) =&gt; &lt;<span class="hljs-module-identifier">ErrorIndicator</span> error /&gt;
      | <span class="hljs-constructor">Done</span>(<span class="hljs-constructor">Ok</span>(statistics)) =&gt; &lt;<span class="hljs-module-identifier">Stats</span> statistics /&gt;
      }
    }
  &lt;/&gt;
};
</code></pre>
</div><style data-emotion-css="sq4ju6">.css-sq4ju6{padding:10px 0;}</style><div class="css-sq4ju6"><div class="BeOpWidget"></div></div></div><style data-emotion-css="18aspvx">.css-18aspvx{background-color:#46515B;color:#fff;text-align:center;padding:20px;font-size:14px;}</style><div class="css-18aspvx">Copyright 2020 - Matthias Le Brun</div></div></div><script id="data">window.initialData = {"posts":{"key":"2019-01-24-orchestrating-requests-at-component-level","value":[[{"title":"Orchestrating requests at component level","date":"2019-01-24T00:00:00.000Z","body":"\u003cp>\u003ca href=\"/blog/2019-01-20-requests-with-reasonml/\">In a previous article\u003c/a>, we saw how we can model request statuses in our ReasonReact component state, so that we prevent weird or impossible states.\u003c/p>\n\u003cp>Now, let's see how we can orchestrate them \u003cstrong>within\u003c/strong> our components.\u003c/p>\n\u003cp>When I was using JavaScript, I generally put all the logic involving server requests in Redux. This wasn't an obligation, but thinking in actions really helped figuring out what was happening, which was harder when calling \u003ccode>setState\u003c/code> all over the place. Using Reason, and given the evolution of React, I feel I don't need this anymore:\u003c/p>\n\u003cul>\n\u003cli>with reducer components, \u003cstrong>thinking in actions and state\u003c/strong> can happen locally\u003c/li>\n\u003cli>props drilling is ok when backed by a \u003cstrong>static type system\u003c/strong>\u003c/li>\n\u003cli>portals reduce the need for a global store that components subscribe to: you can \u003cstrong>pass the data\u003c/strong> from a component \u003cstrong>to a portal\u003c/strong> that's rendered elsewhere\u003c/li>\n\u003cli>true isolation between components makes a lot of things easier: they're \u003cstrong>reusable\u003c/strong>, their \u003cstrong>data dependencies are explicit\u003c/strong> and statically analysable, and their implementation doesn't leak to a shared store\u003c/li>\n\u003cli>reducer components embed a \u003ca href=\"https://reasonml.github.io/reason-react/docs/en/state-actions-reducer#state-update-through-reducer\">powerful update mechanism\u003c/a>, which is much more practical than using lifecycle or chaining promises in actions\u003c/li>\n\u003c/ul>\n\u003ch2>In practice\u003c/h2>\n\u003cp>Let's say we have a component that needs to fetch a \u003ccode>User\u003c/code> and then fetch their \u003ccode>Statistics\u003c/code>, which are identified by a value we might find in the payload of the first request.\u003c/p>\n\u003cp>First, we can write an interface file (\u003ccode>.rei\u003c/code>) that lets us define what we want to expose from the implementation file we're about to do:\u003c/p>\n\u003cpre>\u003ccode class=\"language-reason\">\u003cspan class=\"hljs-keyword\">type\u003c/span> state;\n\n\u003cspan class=\"hljs-keyword\">type\u003c/span> action;\n\n\u003cspan class=\"hljs-keyword\">let\u003c/span> make = array(\u003cspan class=\"hljs-module-identifier\">React\u003c/span>.reactElement) =&gt;\n  \u003cspan class=\"hljs-module-identifier\">React\u003c/span>.component(state, \u003cspan class=\"hljs-module-identifier\">React\u003c/span>.noRetainedProps, action);\n\u003c/code>\u003c/pre>\n\u003cp>This will help the compiler notice dead code, and making \u003ccode>state\u003c/code> and \u003ccode>action\u003c/code> opaque to the outside world even enables us to check if action constructors ever used, enabling the removal of entire codepaths that aren't ever executed!\u003c/p>\n\u003cp>Now for the implementation file:\u003c/p>\n\u003cp>Define the state we want:\u003c/p>\n\u003cpre>\u003ccode class=\"language-reason\">\u003cspan class=\"hljs-keyword\">type\u003c/span> state = {\n  user: \u003cspan class=\"hljs-module-identifier\">RequestStatus\u003c/span>.t(\u003cspan class=\"hljs-module-identifier\">Result\u003c/span>.t(\u003cspan class=\"hljs-module-identifier\">User\u003c/span>.t, \u003cspan class=\"hljs-module-identifier\">Errors\u003c/span>.t)),\n  statistics: \u003cspan class=\"hljs-module-identifier\">RequestStatus\u003c/span>.t(\u003cspan class=\"hljs-module-identifier\">Result\u003c/span>.t(\u003cspan class=\"hljs-module-identifier\">Statistics\u003c/span>.t, \u003cspan class=\"hljs-module-identifier\">Errors\u003c/span>.t)),\n};\n\u003c/code>\u003c/pre>\n\u003cp>The actions that will occur:\u003c/p>\n\u003cpre>\u003ccode class=\"language-reason\">\u003cspan class=\"hljs-keyword\">type\u003c/span> action =\n  | \u003cspan class=\"hljs-constructor\">LoadUser\u003c/span>\n  | \u003cspan class=\"hljs-constructor\">ReceiveUser\u003c/span>(\u003cspan class=\"hljs-module-identifier\">Result\u003c/span>.t(\u003cspan class=\"hljs-module-identifier\">User\u003c/span>.t, \u003cspan class=\"hljs-module-identifier\">Errors\u003c/span>.t))\n  | \u003cspan class=\"hljs-constructor\">LoadStatistics\u003c/span>(string)\n  | \u003cspan class=\"hljs-constructor\">ReceiveStatistics\u003c/span>(\u003cspan class=\"hljs-module-identifier\">Result\u003c/span>.t(\u003cspan class=\"hljs-module-identifier\">Statistics\u003c/span>.t, \u003cspan class=\"hljs-module-identifier\">Errors\u003c/span>.t));\n\u003c/code>\u003c/pre>\n\u003cp>Our initial state will look like this:\u003c/p>\n\u003cpre>\u003ccode class=\"language-reason\">\u003cspan class=\"hljs-keyword\">let\u003c/span> initialState = {user: \u003cspan class=\"hljs-constructor\">NotAsked\u003c/span>, statistics: \u003cspan class=\"hljs-constructor\">NotAsked\u003c/span>};\n\u003c/code>\u003c/pre>\n\u003cp>So, we now have the basics! We can start writing our reducer:\u003c/p>\n\u003cpre>\u003ccode class=\"language-reason\">\u003cspan class=\"hljs-keyword\">let\u003c/span> reducer = (action, state) =&gt;\n  \u003cspan class=\"hljs-keyword\">switch\u003c/span> (action) {\n  \u003cspan class=\"hljs-comment\">/* show as loading, then start the request */\u003c/span>\n  | \u003cspan class=\"hljs-constructor\">LoadUser\u003c/span> =&gt;\n    \u003cspan class=\"hljs-constructor\">UpdateWithSideEffects\u003c/span>(\n      {\u003cspan class=\"hljs-operator\">...\u003c/span>state, user: \u003cspan class=\"hljs-constructor\">Loading\u003c/span>},\n      (\n        ({send}) =&gt;\n          \u003cspan class=\"hljs-module-identifier\">User\u003c/span>.get()\u003cspan class=\"hljs-operator\">-&gt;\u003c/span>\u003cspan class=\"hljs-module-identifier\">Future\u003c/span>.get(payload =&gt; send(\u003cspan class=\"hljs-constructor\">ReceiveUser\u003c/span>(payload)))\n      ),\n    )\n  \u003cspan class=\"hljs-comment\">/* when we find a statisticsKey, set the user and start the second request */\u003c/span>\n  | \u003cspan class=\"hljs-constructor\">ReceiveUser\u003c/span>(\u003cspan class=\"hljs-constructor\">Ok\u003c/span>({statisticsKey: \u003cspan class=\"hljs-constructor\">Some\u003c/span>(key)}) \u003cspan class=\"hljs-keyword\">as\u003c/span> user) =&gt;\n    \u003cspan class=\"hljs-constructor\">UpdateWithSideEffects\u003c/span>(\n      {\u003cspan class=\"hljs-operator\">...\u003c/span>state, user: \u003cspan class=\"hljs-constructor\">Done\u003c/span>(user)},\n      (({send}) =&gt; send(\u003cspan class=\"hljs-constructor\">LoadStatistics\u003c/span>(key))),\n    )\n  \u003cspan class=\"hljs-comment\">/* otherwise just set the user */\u003c/span>\n  | \u003cspan class=\"hljs-constructor\">ReceiveUser\u003c/span>(user) =&gt; \u003cspan class=\"hljs-constructor\">Update\u003c/span>({\u003cspan class=\"hljs-operator\">...\u003c/span>state, user: \u003cspan class=\"hljs-constructor\">Done\u003c/span>(user)})\n  | \u003cspan class=\"hljs-constructor\">LoadStatistics\u003c/span>(key) =&gt;\n    \u003cspan class=\"hljs-constructor\">UpdateWithSideEffects\u003c/span>(\n      {\u003cspan class=\"hljs-operator\">...\u003c/span>state, statistics: \u003cspan class=\"hljs-constructor\">Loading\u003c/span>},\n      (\n        ({send}) =&gt;\n          \u003cspan class=\"hljs-module-identifier\">Statistics\u003c/span>.get(key)\n          \u003cspan class=\"hljs-operator\">-&gt;\u003c/span>\u003cspan class=\"hljs-module-identifier\">Future\u003c/span>.get(payload =&gt; send(\u003cspan class=\"hljs-constructor\">ReceiveStatistics\u003c/span>(payload)))\n      ),\n    )\n  | \u003cspan class=\"hljs-constructor\">ReceiveStatistics\u003c/span>(statistics) =&gt;\n    \u003cspan class=\"hljs-constructor\">Update\u003c/span>({\u003cspan class=\"hljs-operator\">...\u003c/span>state, statistics: \u003cspan class=\"hljs-constructor\">Done\u003c/span>(statistics)})\n  };\n\u003c/code>\u003c/pre>\n\u003cp>Pattern matching our actions is really interesting here:\u003c/p>\n\u003cul>\n\u003cli>If the \u003ccode>User\u003c/code> request fails or doesn't contain a \u003ccode>statisticsKey\u003c/code>, we don't even bother querying \u003ccode>Statistics\u003c/code>: we just store the error or user in state, and can render UI accordingly\u003c/li>\n\u003cli>We can easily see the request chaining\u003c/li>\n\u003c/ul>\n\u003cp>All that's left to do is a bit of pattern matching in our render function:\u003c/p>\n\u003cpre>\u003ccode class=\"language-reason\">\u003cspan class=\"hljs-keyword\">switch\u003c/span> (state.user) {\n| \u003cspan class=\"hljs-constructor\">NotAsked\u003c/span> =&gt; \u003cspan class=\"hljs-module-identifier\">React\u003c/span>.null\n| \u003cspan class=\"hljs-constructor\">Loading\u003c/span> =&gt; &lt;\u003cspan class=\"hljs-module-identifier\">ActivityIndicator\u003c/span> /&gt;\n| \u003cspan class=\"hljs-constructor\">Done\u003c/span>(\u003cspan class=\"hljs-constructor\">Error\u003c/span>(error)) =&gt; &lt;\u003cspan class=\"hljs-module-identifier\">ErrorIndicator\u003c/span> error /&gt;\n| \u003cspan class=\"hljs-constructor\">Done\u003c/span>(\u003cspan class=\"hljs-constructor\">Ok\u003c/span>(user)) =&gt;\n  &lt;&gt;\n    &lt;\u003cspan class=\"hljs-module-identifier\">UserCard\u003c/span> user /&gt;\n    {\n      \u003cspan class=\"hljs-keyword\">switch\u003c/span> (state.statistics) {\n      | \u003cspan class=\"hljs-constructor\">NotAsked\u003c/span> =&gt; \u003cspan class=\"hljs-module-identifier\">React\u003c/span>.null\n      | \u003cspan class=\"hljs-constructor\">Loading\u003c/span> =&gt; &lt;\u003cspan class=\"hljs-module-identifier\">ActivityIndicator\u003c/span> /&gt;\n      | \u003cspan class=\"hljs-constructor\">Done\u003c/span>(\u003cspan class=\"hljs-constructor\">Error\u003c/span>(error)) =&gt; &lt;\u003cspan class=\"hljs-module-identifier\">ErrorIndicator\u003c/span> error /&gt;\n      | \u003cspan class=\"hljs-constructor\">Done\u003c/span>(\u003cspan class=\"hljs-constructor\">Ok\u003c/span>(statistics)) =&gt; &lt;\u003cspan class=\"hljs-module-identifier\">Stats\u003c/span> statistics /&gt;\n      }\n    }\n  &lt;/&gt;\n};\n\u003c/code>\u003c/pre>\n"}]],"height":1},"postList":0}</script>
    <script>
      window.beOpAsyncInit = function() {
        BeOpSDK.init({
          account: "556e1d2772a6b60100844051"
        });
        BeOpSDK.watch();
      };
    </script>
    <script defer src="https://widget.beop.io/sdk.js"></script>
  <script type="text/javascript" src="/app.584345de999128bd8c1b.js" defer></script></body>
</html>
